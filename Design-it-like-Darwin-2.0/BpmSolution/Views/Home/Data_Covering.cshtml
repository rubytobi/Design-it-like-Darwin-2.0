<h3>Covering</h3>
<table id="tableCover" class="table table-hover">
    <thead>
        <tr>
            <td>Name</td>
            <td>...</td>
            <td>
                <a href="#modalCover" data-toggle="modal">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                </a>
            </td>
        </tr>
    </thead>
    <tbody></tbody>
</table>
<div id="modalCover" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "formDataCover" }))
            {
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Create Cover</h4>
                </div>
                <div class="modal-body">
                    @Html.AntiForgeryToken()

                    <div class="form-horizontal col-md-10">
                        <div class="form-group">
                            <label for="inputActivity">Select Activity:</label>
                            <select multiple class="form-control" id="inputActivity"></select>
                        </div>

                        <div class="form-group">
                            <label for="inputDecision">Select Decision:</label>
                            <select multiple class="form-control" id="inputDecision"></select>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <input type="submit" id="submitFormDataCover" class="btn btn-success" value="Create" />
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
                <script>
                    $(function () {
                        $('#formDataCover').submit(function () {
                            if ($(this).valid()) {

                                var activities = $('#inputActivity').val();
                                var decisions = $('#inputDecisions').val();

                                var models = [];

                                activities.forEach(function (activity) {
                                    decisions.forEach(function (decision) {

                                        var model = new Object();
                                        model.activityName = activity;
                                        model.decisionId = decision.id;
                                        model.decisionValue = decision.value;
                                        models.push(model);
                                    });
                                });

                                $.ajax({
                                    url: "/api/covers",
                                    type: "POST",
                                    data: JSON.stringify(models),
                                    contentType: "application/json",
                                    success: function () {
                                        $("#modalCover").modal("hide");
                                        $('#formDataCover').trigger("reset");
                                    },
                                    error: function () {
                                        // TODO
                                    }
                                });
                            }

                            return false;
                        });
                    });
                </script>
            }
        </div>

    </div>
</div>
<script>

    $(function () {
        setInterval(function () {
            $.getJSON({
                url: '/api/covers',
                type: "GET",
                success: function (data) {
                    if (data == null || data.length == 0 || data[0] == null) {
                        return;
                    }

                    var decisions = [];
                    data.forEach(function (input) {
                        var d = { id: input.decisionId, value: input.decisionValue };
                        if ($.inArray(d, decisions) < 0) {
                            decisions.push(d);
                        }
                    });

                    var activities = [];
                    data.forEach(function (input) {
                        if ($.inArray(input.activityName, activities) < 0) {
                            activities.push(input.activityName);
                        }
                    });

                    $('#inputDecision').empty();
                    decisions.forEach(function (decision) {
                        $('#inputDecision').append("<option value=\"" + decision + "\">" + decisions.id + " " + decision.value + "</option>");
                    });

                    $('#inputActivity').empty();
                    activities.forEach(function (activity) {
                        $('#inputActivity').append("<option>" + activity + "</option>");
                    });

                    $('#tableCover thead').empty();
                    var thead = '<tr><td>Name</td>';
                    decisions.forEach(function (decision) {
                        thead += '<td>' + decision.id + "-" + decision.value + '</td>';
                    });
                    thead += '<td><a href="#modalCover" data-toggle="modal"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a></td></tr>';
                    $('#tableCover thead').append(thead);

                    $('#tableCover tbody').empty();
                    activities.forEach(function (item) {
                        var s = '<tr><td>' + item + '</td>';

                        decisions.forEach(function (decision) {
                            var val = $.grep(data,
                                function (value) {
                                    return (value.activityName == item) && (value.decisionId == decision.id) && (value.decisionValue == decision.value);
                                });

                            if (val.length > 0) {
                                s += '<td><span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>';
                                s += '&nbsp;<a href="javascript:dataDeleteCover(\'' + val[0].id + '\')"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></a></td>';
                            } else {
                                //s += '<td><span class="glyphicon glyphicon-remove text-danger" aria-hidden="true"></span></td>';
                                s += '<td></td>';
                            }
                        });

                        //s += '<td><a href="javascript:dataDeleteInput(\'' + item.id + '\')"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></a></td></tr>';

                        $('#tableCover tbody').append(s);
                    });
                }
            });
        },
    reloadInterval); // every 3 sec
    });

    function dataDeleteCover(id) {
        $.ajax({
            url: "/api/covers/" + id,
            type: "DELETE",
            success: function () {
                // TODO
            },
            error: function () {
                // TODO
            }
        });
    }
</script>
